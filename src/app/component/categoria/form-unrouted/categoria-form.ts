import { Component, OnInit, Input, Output, EventEmitter, inject, signal, effect } from '@angular/core';
import { FormBuilder, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
import { HttpErrorResponse } from '@angular/common/http';
import { CommonModule } from '@angular/common';
import { MatSnackBar } from '@angular/material/snack-bar';
import { MatDialog } from '@angular/material/dialog';
import { CategoriaService } from '../../../service/categoria';
import { TemporadaService } from '../../../service/temporada';
import { ICategoria } from '../../../model/categoria';
import { ITemporada } from '../../../model/temporada';
import { TemporadaPlistAdminUnrouted } from '../../temporada/plist-admin-unrouted/temporada-plist-admin-unrouted';

@Component({
  selector: 'app-categoria-form-unrouted',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './categoria-form.html',
  styleUrls: ['./categoria-form.css']
})
export class CategoriaFormAdminUnrouted implements OnInit {
  @Input() categoria: ICategoria | null = null;
  @Input() mode: 'create' | 'edit' = 'create';
  @Output() formSuccess = new EventEmitter<void>();
  @Output() formCancel = new EventEmitter<void>();

  private fb = inject(FormBuilder);
  private snackBar = inject(MatSnackBar);
  private oCategoriaService = inject(CategoriaService);
  private oTemporadaService = inject(TemporadaService);
  private dialog = inject(MatDialog);

  categoriaForm!: FormGroup;
  loading = signal(false);
  error = signal<string | null>(null);
  submitting = signal(false);
  temporadas = signal<ITemporada[]>([]);
  selectedTemporada = signal<ITemporada | null>(null);

  constructor() {
    effect(() => {
      const c = this.categoria;
      if (c && this.categoriaForm) {
        this.loadCategoriaData(c);
      }
    });
  }

  ngOnInit(): void {
    this.initForm();
    this.loadTemporadas();
    if (this.categoria) {
      this.loadCategoriaData(this.categoria);
    }
  }

  private initForm(): void {
    this.categoriaForm = this.fb.group({
      id: [{ value: 0, disabled: true }],
      nombre: ['', [Validators.required, Validators.minLength(4), Validators.maxLength(255)]],
      id_temporada: [null, Validators.required]
    });
  }

  private loadCategoriaData(categoria: ICategoria): void {
    this.categoriaForm.patchValue({
      id: categoria.id,
      nombre: categoria.nombre,
      id_temporada: categoria.temporada?.id
    });
    if (categoria.temporada) {
      this.syncTemporada(categoria.temporada.id);
    }
  }

  private syncTemporada(id: number | null): void {
    if (!id) {
      this.selectedTemporada.set(null);
      return;
    }
    this.oTemporadaService.get(id).subscribe({
      next: (temporada) => {
        this.selectedTemporada.set(temporada);
      },
      error: (err: HttpErrorResponse) => {
        console.error('Error al sincronizar temporada:', err);
        this.snackBar.open('Error al cargar la temporada seleccionada', 'Cerrar', { duration: 3000 });
        this.selectedTemporada.set(null);
      }
    });
  }

  openTemporadaFinderModal(): void {
    const dialogRef = this.dialog.open(TemporadaPlistAdminUnrouted, {
      height: '800px',
      width: '1100px',
      maxWidth: '95vw',
      panelClass: 'temporada-dialog',
      data: { title: 'Elige una temporada', message: 'Selecciona la temporada para la categoría' }
    });

    dialogRef.afterClosed().subscribe((temporada: ITemporada | null) => {
      if (temporada) {
        this.categoriaForm.patchValue({ id_temporada: temporada.id });
        this.syncTemporada(temporada.id);
        this.snackBar.open(`Temporada seleccionada: ${temporada.descripcion}`, 'Cerrar', { duration: 3000 });
      }
    });
  }

  private loadTemporadas(): void {
    this.oTemporadaService.getPage(0, 1000, 'descripcion', 'asc', '', 0).subscribe({
      next: (page) => this.temporadas.set(page.content),
      error: (err: HttpErrorResponse) => {
        console.error(err);
        this.snackBar.open('Error cargando temporadas', 'Cerrar', { duration: 3000 });
      }
    });
  }

  get nombre() { return this.categoriaForm.get('nombre'); }
  get id_temporada() { return this.categoriaForm.get('id_temporada'); }

  onSubmit(): void {
    if (this.categoriaForm.invalid) {
      this.snackBar.open('Por favor, complete todos los campos correctamente', 'Cerrar', { duration: 4000 });
      return;
    }

    this.submitting.set(true);

    const categoriaData: any = {
      nombre: this.categoriaForm.value.nombre,
      temporada: { id: this.categoriaForm.value.id_temporada }
    };

    if (this.mode === 'edit' && this.categoria?.id) {
      categoriaData.id = this.categoria.id;
      this.oCategoriaService.update(categoriaData).subscribe({
        next: () => { this.snackBar.open('Categoría actualizada exitosamente', 'Cerrar', { duration: 4000 }); this.submitting.set(false); this.formSuccess.emit(); },
        error: (err: HttpErrorResponse) => { this.error.set('Error actualizando la categoría'); this.snackBar.open('Error actualizando la categoría', 'Cerrar', { duration: 4000 }); console.error(err); this.submitting.set(false); }
      });
    } else {
      this.oCategoriaService.create(categoriaData).subscribe({
        next: () => { this.snackBar.open('Categoría creada exitosamente', 'Cerrar', { duration: 4000 }); this.submitting.set(false); this.formSuccess.emit(); },
        error: (err: HttpErrorResponse) => { this.error.set('Error creando la categoría'); this.snackBar.open('Error creando la categoría', 'Cerrar', { duration: 4000 }); console.error(err); this.submitting.set(false); }
      });
    }
  }

  onCancel(): void { this.formCancel.emit(); }
}
